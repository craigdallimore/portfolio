module.exports = function(grunt) {

    var _ = require('underscore');

    grunt.registerMultiTask('undertmpl', 'Compile underscore templates to JS', function() {

        var files = grunt.file.expandFiles(this.file.src),
            dest = this.file.dest || '.',
            src = grunt.helper('templates', files);

        grunt.file.write(dest, src);
        grunt.log.writeln("Underscore templates rendered as JavaScript");

    });

    grunt.registerHelper('templates', function(files) {
        var output = 'App.module("Tmpl", function(Tmpl, App) {\n';

        files.map( function(filepath) {
            output += '    Tmpl.' +
            filepath.replace('static/templates/', '').replace('.html', '') + '=' + _.template(grunt.task.directive(filepath, grunt.file.read)).source.replace(/(\n|\t|\\n|\\t)/gi, '').replace(/\s+/gi, ' ') + ';\n';
        });

        output += '});';

        return output;
    });

};
